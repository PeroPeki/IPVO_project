<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stolovi</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <button id="backBtn" class="back-btn">‚Üê Natrag</button>
            <h2 id="eventTitle"></h2>
        </div>
        <div id="tables" class="tables-grid"></div>
        <div id="noAccess" class="no-access hidden">
            <p>‚ùå Trebate kupiti kartu za ovaj event kako biste vidjeli stolove!</p>
            <button id="buyBtn" class="btn-primary">Kupi kartu</button>
        </div>
    </div>

    <script>
        console.log("tables.html UƒåITAN");

        function checkUser() {
            const username = localStorage.getItem('username');
            console.log("Username:", username);
            if (!username) {
                window.location.href = '/index.html';
                return false;
            }
            return true;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event_id');
        const eventName = urlParams.get('event_name');
        const username = localStorage.getItem('username');

        console.log("Event ID:", eventId);
        console.log("Username:", username);

        document.getElementById('eventTitle').textContent = eventName || 'Stolovi';
        document.getElementById('backBtn').onclick = () => window.history.back();

        function checkIfHasTicket() {
            const url = `/api/users/${username}/has-ticket/${eventId}`;
            console.log("GET na:", url);
            
            return fetch(url)
                .then(r => {
                    console.log("Response status:", r.status);
                    return r.json();
                })
                .then(data => {
                    console.log("Has ticket response:", data);
                    return data.hasTicket || false;
                })
                .catch(err => {
                    console.error('Gre≈°ka pri check-u:', err);
                    return false;
                });
        }

        async function loadTables() {
            console.log("Poƒçinjem provjeru karte...");
            const hasTicket = await checkIfHasTicket();
            console.log("Has ticket?", hasTicket);
            
            if (!hasTicket) {
                console.log("Korisnik NEMA kartu - pokazujem no-access");
                document.getElementById('tables').style.display = 'none';
                document.getElementById('noAccess').classList.remove('hidden');
                
                document.getElementById('buyBtn').onclick = () => {
                    window.location.href = `/buy-ticket.html?event_id=${eventId}&event_name=${encodeURIComponent(eventName)}`;
                };
                return;
            }

            console.log("Korisnik IMA kartu - uƒçitavam stolove");
            const url = `/api/events/${eventId}/tables`;
            console.log("GET na:", url);

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    console.log("Tables response:", data);
                    const tablesDiv = document.getElementById('tables');
                    tablesDiv.innerHTML = '';
                    if (!data.tables || data.tables.length === 0) {
                        tablesDiv.innerHTML = '<p style="grid-column: 1/-1; text-align: center;">Nema dostupnih stolova.</p>';
                        return;
                    }
                    data.tables.forEach(table => {
                        const card = document.createElement('div');
                        card.className = `table-card ${table.status}`;

                        const num = document.createElement('div');
                        num.className = 'table-number';
                        num.textContent = `ü™ë ${table.number}`;

                        const status = document.createElement('div');
                        status.className = 'table-status';
                        status.textContent = table.status === 'free' ? '‚úÖ Slobodan' : '‚ùå Rezerviran';

                        const btn = document.createElement('button');
                        if (table.status === 'free') {
                            btn.textContent = 'üìù Rezerviraj';
                            btn.onclick = () => confirmReserve(table);
                        } else {
                            btn.textContent = 'üö´ Otka≈æi';
                            btn.onclick = () => confirmCancel(table);
                        }

                        card.appendChild(num);
                        card.appendChild(status);
                        card.appendChild(btn);
                        tablesDiv.appendChild(card);
                    });
                })
                .catch(err => {
                    console.error('Gre≈°ka pri uƒçitavanju stolova:', err);
                });
        }

        function confirmReserve(table) {
            if (window.confirm(`≈Ωelite li rezervirati stol ${table.number}?`)) {
                reserveTable(table.id);
            }
        }

        function confirmCancel(table) {
            if (window.confirm(`≈Ωelite li otkazati rezervaciju stola ${table.number}?`)) {
                cancelTable(table.id);
            }
        }

        function reserveTable(tableId) {
            fetch(`/api/events/${eventId}/tables/${tableId}/reserve`, {
                method: 'POST'
            }).then(r => r.json()).then(() => loadTables());
        }

        function cancelTable(tableId) {
            fetch(`/api/events/${eventId}/tables/${tableId}/cancel`, {
                method: 'POST'
            }).then(r => r.json()).then(() => loadTables());
        }

        if (checkUser()) {
            loadTables();
        }
    </script>
</body>
</html>
