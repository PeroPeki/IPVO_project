version: "3.9"

services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - app-net

  web1:
    container_name: web1
    build: ./frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
    labels:
      - "traefik.enable=true"
      # Hvatamo sve na localhost, ali s manjim prioritetom od API-ja
      - 'traefik.http.routers.web.rule=Host("localhost") && PathPrefix("/")'
      - "traefik.http.routers.web.entrypoints=web"
      - "traefik.http.services.web.loadbalancer.server.port=80"
    networks:
      - app-net

  web2:
    container_name: web2
    build: ./frontend
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
    labels:
      - "traefik.enable=true"
      # web2 dijeli isti router/servis kao web1 za load balancing
      - "traefik.http.services.web.loadbalancer.server.port=80"
    networks:
      - app-net

  backend:
    build: ./backend
    volumes:
      - ./backend:/app
    environment:
      - FLASK_ENV=development
      - FLASK_DEBUG=1
      - MONGO_URI=mongodb://mongo:27017
      - RABBITMQ_URI=amqp://guest:guest@rabbitmq:5672/
    depends_on:
      - mongo
      - rabbitmq
    labels:
      - "traefik.enable=true"
      # Hvatamo API i WebSocket promet
      - 'traefik.http.routers.api.rule=Host("localhost") && (PathPrefix("/api") || PathPrefix("/socket.io"))'
      # BITNO: Dajemo veći prioritet da frontend ne "proguta" ove zahtjeve
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.services.api.loadbalancer.server.port=5000"
      # Sticky sessions za WebSockete
      - "traefik.http.services.api.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.api.loadbalancer.sticky.cookie.name=backend_sticky"
    networks:
      - app-net

  analytics_worker:
    build: ./backend
    # -A tasks: tasks
    # worker: pokreni radnika
    # --beat: pokreni i sat (timer) unutar istog kontejnera
    # --loglevel=info: da vidimo što radi
    command: celery -A tasks worker --beat --loglevel=info
    volumes:
      - ./backend:/app
    environment:
      - MONGO_URI=mongodb://mongo:27017
      - RABBITMQ_URI=amqp://guest:guest@rabbitmq:5672/
    depends_on:
      - mongo
      - rabbitmq
    networks:
      - app-net


  mongo:
    image: mongo:7.0
    container_name: mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
     - mongo_:/data/db
     - ./mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - app-net

  seed:
    build:
      context: ./seed-tools
    depends_on:
      - mongo
    networks:
      - app-net

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    restart: always
    ports:
      - "5672:5672"   # Glavni port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-net

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-net

networks:
  app-net: {}

volumes:
  mongo_: {}
